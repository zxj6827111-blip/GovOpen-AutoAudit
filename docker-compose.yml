version: '3.8'

services:
  backend:
    build:
      context: .
      dockerfile: Dockerfile
    command: python -m platform.server
    ports:
      - "${PORT:-8000}:8000"
    volumes:
      - ./runs:/app/runs
      - ./rulepacks:/app/rulepacks
      - ./sandbox:/app/sandbox
    environment:
      - DATA_DIR=/app/runs
      - RULEPACK_DIR=/app/rulepacks
    restart: unless-stopped

  frontend:
    image: nginx:alpine
    ports:
      - "8080:80"
    volumes:
      - ./runs:/usr/share/nginx/html/runs:ro
      # Check if we have a simple index.html for the dashboard, otherwise simple directory listing
      # Simple config to enable directory listing for "runs" browsing
    command: /bin/sh -c "echo 'server { listen 80; location / { root /usr/share/nginx/html; autoindex on; } }' > /etc/nginx/conf.d/default.conf && nginx -g 'daemon off;'"

  sandbox:
    build:
      context: .
      dockerfile: Dockerfile
    command: python scripts/start_sandbox.py
    ports:
      - "8001:8000"
